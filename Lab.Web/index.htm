<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lab</title>
  <link href="/content/css/foundation.css" rel="stylesheet"/>
  <link href="/content/css/app.css" rel="stylesheet"/>
</head>
<body>
  <div id="app">
    <div class="banner">Lab</div>
    <div class="container">
      <div id="main"></div>  
    </div>
  </div>

  <!-- Decks Index -->

  <script id="decks-index-layout" type="text/html">
    <div id="deck-index-region"></div>
  </script>

  <script id="decks-index-template" type="text/html">
    <form action="/decks" method="POST">
      <input type="text" />
      <input type="submit" class="button" />
    </form>
    <table>
      <thead>
        <tr>
          <th>Title</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </script>

  <script id="decks-table-row-template" type="text/html">
    <td><a class="small alert button delete">x</a> <a href="#decks/<%= id %>/edit"><%= title %></a></td>  
  </script>

  <script src="/content/js/lib/jquery.js"></script>
  <script src="/content/js/lib/underscore.js"></script>
  <script src="/content/js/lib/backbone.js"></script>
  <script src="/content/js/lib/backbone.marionette.js"></script>
  <script src="/content/js/data.js"></script>

  <script>

  /* App
  /******************************/

  var App = new Backbone.Marionette.Application();

  App.addRegions({ content: "#main" });

  App.vent.on("app:layout:rendered", function(){
    new AppRouter();
    Backbone.history.start({silent:false});
  });


  /* Models
  /******************************/
  var Deck = Backbone.Model.extend({
    url:function(){
      var url = '/decks', id = this.get('id');
      id && (url += ('/'+id))
      return url;
    }  
  });

  /* Collections
  /******************************/
  var DeckCollection = Backbone.Collection.extend({
    url:'/decks',
    model: Deck    
  });


  /* Views
  /******************************/
  var DecksIndexLayout = Backbone.Marionette.Layout.extend({
    template: '#decks-index-layout',

    regions: {
      decks: '#deck-index-region'
    },

    initialize: function(){
      var collection = new DeckCollection();      
        
      collection.fetch();
      
      this.collection = collection;
    },

    onRender:function(){
      var view = new DecksIndexView({ collection: this.collection });      
      this.decks.show( view );
    }
  });

  var DecksTableRowView = Backbone.Marionette.ItemView.extend({
    tagName:'tr',
    template: '#decks-table-row-template',
    events: { 
      'click .delete' : 'deleteDeck' 
    },
    deleteDeck: function(){
      this.model.destroy();
    }
  });

  var DecksIndexView = Backbone.Marionette.CompositeView.extend({
    className:'decks-index',
    itemView: DecksTableRowView,
    template: '#decks-index-template',

    events: {
      'submit':'createDeck'
    },

    ui: {
      input:"[type='text']"
    },

    createDeck: function(){
      var input = this.ui.input,
          model = new Deck(),
          view = this;

      model.save({title:input.val()})
           .done(function(){ view.collection.add(model); })

      input.val('');
      input.focus();

     return false;
    },

    appendHtml: function(collectionView, itemView){
      collectionView.$('tbody').append(itemView.el);
    }
  });

  /* Controllers
  /******************************/
  var DecksController = {
    index: function(){
      var view = new DecksIndexLayout();
      App.content.show( view );
    }
  };

  /* Routers
  /******************************/  
  var DecksRouter = Backbone.Marionette.AppRouter.extend({
    controller: DecksController,
    appRoutes: {
      "decks" : "index"
    }
  });


  /* Initialize
  /******************************/
  App.on("initialize:after", function(){    
    new DecksRouter();
    Backbone.history.start({silent:false});
  });

  App.start();
</script>  

</body>
</html>
